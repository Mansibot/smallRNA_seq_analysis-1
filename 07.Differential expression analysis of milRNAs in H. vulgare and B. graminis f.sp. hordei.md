## Filtering out non-expressed milRNA genes

## Differential expression analysis with `DESeq2`
Loading required packages. 
```R
require(Biobase)
require(DESeq2)
require(apeglm)
require(vsn)
require(ggplot2)
require(IHW)
require(NMF)
```
### Read count normalization
First, we normalized read counts across samples with the `DESeq2` method for normalization. The table `conditions.txt` looked as follows:
```
sample  condition
RSB15248-1	Epi
RSB15248-2	Epi
RSB15248-3	Epi
RSB15248-4	Hau
RSB15248-5	Hau
RSB15248-6	Hau
RSB15248-7	P40
RSB15248-8	P40
RSB15248-9	P40
RSB15248-10	EVplus
RSB15248-11	EVplus
RSB15248-12	EVminus
RSB15248-13	EVminus
RSB15248-14	EVminus
RSB15248-15	EVplus
RSB15248-16	Myc
RSB15248-17	Myc
RSB15248-18	Myc
```
Then, we normalized read counts.
```R
# import data
dat <- read.table("counts.bgh-milRNA.txt", header=TRUE, sep=" ")
names(dat) <- c("geneID","length",
                "RSB15248-1", "RSB15248-2", "RSB15248-3", "RSB15248-4", "RSB15248-5", "RSB15248-6",
                "RSB15248-7", "RSB15248-8", "RSB15248-9", "RSB15248-10", "RSB15248-11", "RSB15248-12",
                "RSB15248-13", "RSB15248-14", "RSB15248-15", "RSB15248-16", "RSB15248-17", "RSB15248-18")
info <- read.table("conditions.txt", header = T, sep = '\t')
# normalize read counts
dds <- DESeqDataSetFromMatrix(dat, info, ~condition) 
keep <- rowSums(counts(dds)) >= 10 # filter out non-expressors
dds <- dds[keep,]
# choose a reference level(which level represents the control group or to compare with)
dds$condition <- factor(dds$condition, levels = c("Epi","Myc","Hau","P40","EVplus","EVminus"))
DESeqSizeFactors <- estimateSizeFactors(dds)
sizeFactors(DESeqSizeFactors)
colData(DESeqSizeFactors)
normCounts <- counts(DESeqSizeFactors, normalized = T)
colSums(normCounts) # should be equal across all samples after normalizing
lognormCounts <- log2(normCounts + 1) # log transformation
# to visually inspect noralization
boxplot(dat,notch=F,main="raw counts",ylab="read counts")
boxplot(normCounts,notch=F,main="normalized",ylab="read counts")
```

### Differential expression analysis and LFC shrinkage
We used `DESeq` to calculate log fold change and p-values of comparisons. 
```R
dds <- DESeq(dds)
resultsNames(dds) # to recal the names of the contrasts
DGEresults.myc <- results(dds, contrast=c("condition","Myc","Epi"), alpha=0.05)
DGEresults.hau <- results(dds, contrast=c("condition","Hau","Epi"), alpha=0.05)
DGEresults.p40 <- results(dds, contrast=c("condition","P40","Epi"), alpha=0.05)
summary(DGEresults.hau)

## 
## out of 1168 with nonzero total read count
## adjusted p-value < 0.05
## LFC > 0 (up)       : 59, 5.1%
## LFC < 0 (down)     : 53, 4.5%
## outliers [1]       : 7, 0.6%
## low counts [2]     : 656, 56%
## (mean count < 3)
```
LFC shrinkage by false discovery rate calculation (Benjamini-Hochberg) was done with `apeglm`. Here shown for Hau vs. Epi, all steps were repeated for Myc vs. Epi and P40 vs. Epi as well. 
```R
resLFC <- lfcShrink(dds, coef="Hau", type="apeglm")
## using 'apeglm' for LFC shrinkage. If used in published research, please cite:
##     Zhu, A., Ibrahim, J.G., Love, M.I. (2018) Heavy-tailed prior distributions for
##     sequence count data: removing the noise and preserving large differences.
##     Bioinformatics. https://doi.org/10.1093/bioinformatics/bty895
resLFC
table(resLFC$padj < 0.1)
## 
## FALSE  TRUE 
##   384   143
resIHW <- results(dds,filterFun=ihw)
## Only 1 bin; IHW reduces to Benjamini Hochberg (uniform weights)
summary(resIHW)
## 
## out of 1168 with nonzero total read count
## adjusted p-value < 0.1
## LFC > 0 (up)       : 59, 5.1%
## LFC < 0 (down)     : 51, 4.4%
## outliers [1]       : 7, 0.6%
## [1] see 'cooksCutoff' argument of ?results
## see metadata(res)$ihwResult on hypothesis weighting
sum(resIHW$padj < 0.1, na.rm=TRUE)
## [1] 110
metadata(resIHW)$ihwResult
## ihwResult object with 1168 hypothesis tests 
## Nominal FDR control level: 0.1 
## Split into 1 bins, based on an ordinal covariate
```
For writing results to tables, here for Hau vs. Epi. 
```R
DGEresultsSorted <- resLFC[order(resLFC$padj),]
DGEgenes <- rownames(subset(DGEresultsSorted, padj < 0.1))
table <- subset(DGEresultsSorted, padj < 0.1)
write.csv(table, "DESEQ_Results_Hau-vs-Epi.csv")
hm.mat_DGEgenes <- lognormCounts[DGEgenes, ]
write.csv(hm.mat_DGEgenes,"DESEQ_Counts_Hau-vs-Epi.csv")
```
To generate a heatmap of differentially expressed genes:
```R
aheatmap(hm.mat_DGEgenes, Rowv = TRUE, Colv = TRUE, distfun = "euclidean", hclustfun = "median")
```

## Differential expression analysis with `EdgeR`
Loading required packages. 
```R
require(limma)
require(edgeR)
require(reshape2)
require(ggplot2)
require(NMF)
```

### Read count normalization

## Differential expression analysis with `Limma-VOOM`

### Read count normalization
